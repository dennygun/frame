<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>80 Tahun Kemerdekaan RI, AR Selfie Frame</title>
  <style>
    /* layout */
    html, body { height:100%; margin:0; background:#000; font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans', 'Helvetica Neue', Arial; color:#fff; }
    #app { position:relative; width:100%; height:100vh; overflow:hidden; }

    video#camera { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#111; }

    .overlay-wrap { position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center; }
    svg.overlay { width:100%; height:100%; }

    .center-cta { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); display:flex; flex-direction:column; gap:12px; align-items:center; z-index:40; }
    .cta-btn { background:#e21b2d; color:white; border:none; padding:14px 20px; border-radius:12px; font-size:18px; box-shadow:0 8px 24px rgba(0,0,0,0.4); }
    .cta-secondary { background:rgba(255,255,255,0.08); padding:10px 14px; border-radius:10px; }

    .ui { position:absolute; left:0; right:0; bottom:18px; display:flex; gap:12px; justify-content:center; pointer-events:auto; z-index:30; }
    button { background:#e21b2d; color:white; border:none; padding:12px 16px; border-radius:10px; font-size:16px; box-shadow:0 6px 18px rgba(0,0,0,0.25); }
    button.secondary { background:rgba(255,255,255,0.12); }

    .topbar { position:absolute; left:12px; top:12px; display:flex; gap:8px; pointer-events:auto; z-index:30; }
    .chip { background:rgba(0,0,0,0.45); color:white; padding:8px 10px; border-radius:999px; font-size:14px; }

    .caption { position:absolute; left:12px; bottom:86px; color:white; font-size:13px; text-shadow:0 2px 6px rgba(0,0,0,0.6); z-index:30; }

    .message { position:absolute; right:12px; top:12px; max-width:320px; background:rgba(0,0,0,0.55); padding:12px; border-radius:10px; font-size:13px; z-index:35; }

    input[type=file] { display:none; }

    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

    /* small hint for insecure context */
    .warning { background:#ffcdd2; color:#000; padding:10px; border-radius:8px; font-size:13px; }

  </style>
</head>
<body>
  <!--
    Manual test cases, follow these to verify fixes
    1, Secure site, click mulai kamera, allow permission, camera preview appears, capture downloads image
    2, Deny permission, see friendly instructions, upload photo works as fallback
    3, Switch camera toggles facing mode, video mirroring only for front camera
    4, Share uses navigator.share if available, otherwise download fallback
    5, Insecure context, show clear instruction to host over https or localhost
  -->

  <div id="app">
    <video id="camera" autoplay playsinline muted></video>

    <div class="overlay-wrap" aria-hidden="true">
      <!-- Inline SVG overlay, transparent center defined by mask -->
      <svg class="overlay" viewBox="0 0 360 780" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <mask id="center-hole">
            <rect x="0" y="0" width="100%" height="100%" fill="white" />
            <rect x="36" y="140" width="288" height="360" rx="18" ry="18" fill="black" />
          </mask>
        </defs>

        <g mask="url(#center-hole)">
          <rect x="0" y="0" width="100%" height="120" fill="#e21b2d" />
          <text x="50%" y="64" text-anchor="middle" alignment-baseline="middle" font-size="22" font-weight="700" fill="#fff">80 Tahun Kemerdekaan RI</text>
          <text x="50%" y="92" text-anchor="middle" alignment-baseline="middle" font-size="12" fill="#fff">Dirgahayu Republik Indonesia</text>

          <g transform="translate(12,12) scale(0.9)">
            <circle cx="20" cy="20" r="16" fill="#ffd54a" />
            <path d="M20 10 L25 20 L20 30 L15 20 Z" fill="#e21b2d" />
          </g>

          <path d="M320 24 q12 10 0 24 q-12 14 -24 0 q-12 -14 0 -24 q12 -10 24 0" fill="#fff" opacity="0.95" />
          <path d="M320 26 q10 8 0 20 q-10 12 -20 0 q-10 -12 0 -20 q10 -8 20 0" fill="#e21b2d" />
        </g>

        <g mask="url(#center-hole)">
          <rect x="0" y="660" width="100%" height="120" fill="#e21b2d" />
          <text x="50%" y="704" text-anchor="middle" alignment-baseline="middle" font-size="16" font-weight="600" fill="#fff">17 Agustus 1945, 80 Tahun</text>
        </g>

        <g mask="url(#center-hole)">
          <circle cx="40" cy="360" r="8" fill="#ffd54a" />
          <circle cx="320" cy="360" r="8" fill="#ffd54a" />
        </g>
      </svg>
    </div>

    <div class="center-cta" id="startPanel">
      <div class="warning" id="contextWarning" style="display:none">Note, camera access requires https, or localhost, if you open this file via file:// some browsers will block camera, host the file on Netlify, GitHub Pages, or a local http server</div>
      <button class="cta-btn" id="startBtn">üì∑ mulai kamera</button>
      <label class="cta-secondary" for="fileInput">atau unggah foto, bila kamera diblok</label>
      <input id="fileInput" type="file" accept="image/*" capture="environment" />
    </div>

    <div class="topbar">
      <div class="chip" id="flipLabel">kamera belum aktif</div>
    </div>

    <div class="message" id="msgBox" style="display:none"></div>

    <div class="caption">Pusat foto tetap transparan, foto bisa diambil atau dibagikan</div>

    <div class="ui">
      <button id="switchBtn" class="secondary" title="Ganti kamera">üîÅ ganti kamera</button>
      <button id="captureBtn">üì∏ ambil foto</button>
      <button id="shareBtn" class="secondary">üì§ bagikan</button>
    </div>

    <a class="sr-only" id="downloadLink">download</a>
  </div>

  <script>
    // improved, defensive camera starter, handles permission denied with friendly instructions,
    // uses user gesture to avoid NotAllowedError in many browsers

    const video = document.getElementById('camera');
    const captureBtn = document.getElementById('captureBtn');
    const shareBtn = document.getElementById('shareBtn');
    const switchBtn = document.getElementById('switchBtn');
    const flipLabel = document.getElementById('flipLabel');
    const startBtn = document.getElementById('startBtn');
    const fileInput = document.getElementById('fileInput');
    const startPanel = document.getElementById('startPanel');
    const msgBox = document.getElementById('msgBox');
    const contextWarning = document.getElementById('contextWarning');

    let stream = null;
    let usingFront = true;
    let usingFileFallback = false;

    function showMessage(text, level='info') {
      msgBox.style.display = 'block';
      msgBox.textContent = text;
      if (level === 'error') msgBox.style.background = 'rgba(255,205,210,0.95)';
      else msgBox.style.background = 'rgba(0,0,0,0.55)';
    }

    function clearMessage() {
      msgBox.style.display = 'none';
      msgBox.textContent = '';
    }

    function isSecureContext() {
      return location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    }

    // show hint if insecure
    if (!isSecureContext()) {
      contextWarning.style.display = 'block';
    }

    async function checkPermissionState() {
      if (!navigator.permissions) return null;
      try {
        const status = await navigator.permissions.query({ name: 'camera' });
        return status.state; // 'granted', 'denied', 'prompt'
      } catch (e) {
        return null;
      }
    }

    async function startCamera() {
      // require user gesture, startPanel will be hidden when camera active
      clearMessage();
      usingFileFallback = false;

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }

      const constraints = { video: { facingMode: usingFront ? 'user' : 'environment', width: { ideal: 1280 }, height: { ideal: 1920 } }, audio: false };

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      } catch (err) {
        console.warn('camera error, trying fallbacks', err);
        // handle permission denied separately
        if (err && err.name === 'NotAllowedError') {
          showMessage('Izin kamera ditolak, izinkan akses kamera pada pengaturan browser, atau gunakan tombol unggah foto sebagai alternatif', 'error');
          // keep start panel visible so user can try upload
          return;
        }

        // try simpler constraint fallback
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        } catch (err2) {
          console.error('fallback also failed', err2);
          showMessage('Tidak dapat mengakses kamera, kemungkinan pembatasan perangkat atau browser, gunakan tombol unggah foto sebagai alternatif', 'error');
          return;
        }
      }

      // success, attach stream
      video.srcObject = stream;
      video.onloadedmetadata = () => video.play();

      // mirror only when front camera requested
      video.style.transform = usingFront ? 'scaleX(-1)' : 'scaleX(1)';

      flipLabel.textContent = usingFront ? 'kamera depan' : 'kamera belakang';
      startPanel.style.display = 'none';
      clearMessage();
    }

    // switch camera request, keep using user gesture to restart
    switchBtn.addEventListener('click', async () => {
      if (usingFileFallback) {
        showMessage('Tidak dapat mengganti kamera saat menggunakan foto unggahan, unggah foto baru untuk mengubah', 'info');
        return;
      }
      usingFront = !usingFront;
      // update transform immediately for visual feedback
      video.style.transform = usingFront ? 'scaleX(-1)' : 'scaleX(1)';
      flipLabel.textContent = 'memulai ulang kamera...';
      await startCamera();
    });

    // convert svg overlay to image using blob, safer for large svg
    function svgToImage(svgEl) {
      const xml = new XMLSerializer().serializeToString(svgEl);
      const blob = new Blob([xml], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = url;
      return new Promise((res, rej) => {
        img.onload = () => { URL.revokeObjectURL(url); res(img); };
        img.onerror = (e) => { URL.revokeObjectURL(url); rej(e); };
      });
    }

    captureBtn.addEventListener('click', async () => {
      // if no stream and not using file fallback, ask user to start camera
      if (!stream && !usingFileFallback) {
        showMessage('Kamera belum aktif, tekan tombol mulai kamera atau unggah foto terlebih dahulu', 'info');
        return;
      }

      // determine dimensions
      let vw = video.videoWidth || video.clientWidth;
      let vh = video.videoHeight || video.clientHeight;
      if (vw === 0 || vh === 0) {
        // fallback to element size
        vw = video.clientWidth;
        vh = video.clientHeight;
      }

      const canvas = document.createElement('canvas');
      canvas.width = vw;
      canvas.height = vh;
      const ctx = canvas.getContext('2d');

      // if mirrored front camera, flip back on canvas draw
      if (!usingFileFallback && usingFront) {
        ctx.save();
        ctx.scale(-1, 1);
        ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
        ctx.restore();
      } else {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      }

      // draw overlay
      try {
        const svgEl = document.querySelector('svg.overlay');
        const img = await svgToImage(svgEl);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      } catch (e) {
        console.warn('gagal convert svg, continuing without overlay', e);
      }

      // auto download
      canvas.toBlob((blob) => {
        if (!blob) {
          showMessage('Gagal membuat file gambar', 'error');
          return;
        }
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'indonesia80.png';
        document.body.appendChild(link);
        link.click();
        link.remove();
      }, 'image/png');
    });

    shareBtn.addEventListener('click', async () => {
      // if camera not active and file fallback not used, prompt
      if (!stream && !usingFileFallback) {
        showMessage('Kamera belum aktif, tekan mulai kamera atau unggah foto untuk dibagikan', 'info');
        return;
      }

      // create canvas same as capture
      let vw = video.videoWidth || video.clientWidth;
      let vh = video.videoHeight || video.clientHeight;
      if (vw === 0 || vh === 0) { vw = video.clientWidth; vh = video.clientHeight; }
      const canvas = document.createElement('canvas');
      canvas.width = vw;
      canvas.height = vh;
      const ctx = canvas.getContext('2d');

      if (!usingFileFallback && usingFront) {
        ctx.save(); ctx.scale(-1, 1); ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height); ctx.restore();
      } else {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      }

      try {
        const svgEl = document.querySelector('svg.overlay');
        const img = await svgToImage(svgEl);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      } catch (e) {
        console.warn('gagal convert svg', e);
      }

      canvas.toBlob(async (blob) => {
        if (!blob) { showMessage('Gagal membuat file untuk dibagikan', 'error'); return; }
        const file = new File([blob], 'indonesia80.png', { type: 'image/png' });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try { await navigator.share({ files: [file], title: 'Dirgahayu ke-80 RI' }); return; } catch (e) { console.warn('share failed', e); }
        }

        if (navigator.share) {
          try {
            const dataUrl = await new Promise(res => canvas.toDataURL('image/png')); // not ideal, but fallback
            await navigator.share({ title: 'Dirgahayu ke-80 RI', url: dataUrl });
            return;
          } catch (e) { console.warn('share url fallback failed', e); }
        }

        // final fallback, download
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'indonesia80.png';
        document.body.appendChild(link);
        link.click();
        link.remove();
      }, 'image/png');
    });

    // start button, must be user gesture to satisfy some browsers
    startBtn.addEventListener('click', async () => {
      // provide extra hint when permission state is denied
      const perm = await checkPermissionState();
      if (perm === 'denied') {
        showMessage('Status izin kamera: ditolak, tolong buka pengaturan browser dan berikan izin kamera untuk situs ini, atau unggah foto sebagai alternatif', 'error');
        return;
      }
      await startCamera();
    });

    // file input fallback, set the selected image as video preview using object URL
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      usingFileFallback = true;
      // stop any active stream
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      video.srcObject = null;
      video.src = url;
      video.onloadedmetadata = () => video.play();
      flipLabel.textContent = 'menggunakan foto unggahan';
      startPanel.style.display = 'none';
      clearMessage();
    });

    // helper to check permission state using permissions API, reused above
    async function checkPermissionState() {
      if (!navigator.permissions) return null;
      try {
        const st = await navigator.permissions.query({ name: 'camera' });
        return st.state;
      } catch (e) {
        return null;
      }
    }

    // hint, do not auto start camera on load, user must press tombol
    // this avoids NotAllowedError in many browsers that require user gesture

    // initial UI state
    flipLabel.textContent = 'kamera belum aktif';
    clearMessage();

  </script>
</body>
</html>
