<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>80 Tahun Kemerdekaan RI, AR Selfie Frame (iOS Fixed)</title>
  <style>
    /* layout */
    html, body { height:100%; margin:0; background:#000; font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans', 'Helvetica Neue', Arial; color:#fff; }
    #app { position:relative; width:100%; height:100vh; overflow:hidden; }

    video#camera { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#111; }
    
    /* Force circular crop for camera on all devices */
    video#camera {
      clip-path: circle(120px at 50% 50%);
      -webkit-clip-path: circle(120px at 50% 50%);
    }
    
    /* Responsive circular crop based on screen size */
    @media (max-width: 480px) {
      video#camera {
        clip-path: circle(min(120px, 33vw) at 50% 50%);
        -webkit-clip-path: circle(min(120px, 33vw) at 50% 50%);
      }
    }
    
    @media (min-width: 481px) {
      video#camera {
        clip-path: circle(120px at 50% 50%);
        -webkit-clip-path: circle(120px at 50% 50%);
      }
    }

    .overlay-wrap { position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center; }
    svg.overlay { width:100%; height:100%; }

    .center-cta { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); display:flex; flex-direction:column; gap:12px; align-items:center; z-index:40; }
    .cta-btn { background:#e21b2d; color:white; border:none; padding:14px 20px; border-radius:12px; font-size:18px; box-shadow:0 8px 24px rgba(0,0,0,0.4); display:flex; align-items:center; gap: 8px; }
    .cta-secondary { background:rgba(255,255,255,0.08); padding:10px 14px; border-radius:10px; }

    .ui { position:absolute; left:0; right:0; bottom: 150px; /* Moved up */ display:flex; gap:12px; justify-content:center; pointer-events:auto; z-index:30; }
    button { background:#e21b2d; color:white; border:none; padding:12px 16px; border-radius:10px; font-size:16px; box-shadow:0 6px 18px rgba(0,0,0,0.25); display:flex; align-items:center; gap: 8px; }
    button.secondary { background:rgba(255,255,255,0.12); }

    .topbar { position:absolute; left:12px; top:12px; display:flex; gap:8px; pointer-events:auto; z-index:30; }
    .chip { background:rgba(0,0,0,0.45); color:white; padding:8px 10px; border-radius:999px; font-size:14px; }

    .caption { position:absolute; left:12px; bottom: 220px; /* Moved up */ color:white; font-size:13px; text-shadow:0 2px 6px rgba(0,0,0,0.6); z-index:30; }

    .message { position:absolute; right:12px; top:12px; max-width:320px; background:rgba(0,0,0,0.55); padding:12px; border-radius:10px; font-size:13px; z-index:35; }

    input[type=file] { display:none; }

    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .warning { background:#ffcdd2; color:#000; padding:10px; border-radius:8px; font-size:13px; }

    /* Styles for iOS image preview */
    #previewOverlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px; box-sizing: border-box;
    }
    #previewOverlay img { max-width: 100%; max-height: 75%; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    #previewOverlay .instruction { color: white; font-size: 16px; text-align: center; margin-top: 20px; }
    #previewOverlay .close-btn { margin-top: 20px; background: #555; }
  </style>
</head>
<body>

  <div id="app">
    <video id="camera" autoplay playsinline muted></video>
    <div class="overlay-wrap" aria-hidden="true">
      <svg class="overlay" viewBox="0 0 360 780" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <mask id="center-hole">
            <rect x="0" y="0" width="100%" height="100%" fill="white" />
            <rect x="36" y="140" width="288" height="360" rx="18" ry="18" fill="black" />
          </mask>
          
          <!-- Gradients for vibrant colors -->
          <linearGradient id="redGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#ff1744;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#e21b2d;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#c62828;stop-opacity:1" />
          </linearGradient>
          
          <linearGradient id="whiteGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#f5f5f5;stop-opacity:1" />
          </linearGradient>
          
          <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#ffb300;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#ff8f00;stop-opacity:1" />
          </linearGradient>
          
          <!-- Japfa Orange Gradient -->
          <linearGradient id="japfaOrange" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#ff6b35;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#e85d28;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#d14d1f;stop-opacity:1" />
          </linearGradient>
          
          <!-- Shadow filters -->
          <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="black" flood-opacity="0.3"/>
          </filter>
          
          <!-- Pattern for decorative elements -->
          <pattern id="batikPattern" patternUnits="userSpaceOnUse" width="20" height="20">
            <rect width="20" height="20" fill="transparent"/>
            <circle cx="10" cy="10" r="2" fill="#ffd700" opacity="0.3"/>
            <circle cx="5" cy="5" r="1" fill="#ffffff" opacity="0.2"/>
            <circle cx="15" cy="15" r="1" fill="#ffffff" opacity="0.2"/>
          </pattern>
          
          <!-- Japfa Logo Path -->
          <g id="japfaLogo">
            <path d="M0,0 Q15,0 15,15 Q15,30 0,30 L0,20 Q8,20 8,15 Q8,10 0,10 Z" fill="url(#japfaOrange)"/>
            <path d="M18,30 L18,0 L25,0 Q35,0 35,10 Q35,15 30,17 L35,30 L28,30 L24,19 L25,19 L25,12 Q25,8 21,8 L25,8 L25,30 Z" fill="url(#japfaOrange)"/>
          </g>
        </defs>
      <svg class="overlay" viewBox="0 0 360 780" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <mask id="center-hole">
            <rect x="0" y="0" width="100%" height="100%" fill="white" />
            <!-- Circular hole for selfie -->
            <circle cx="180" cy="390" r="120" fill="black" />
          </mask>
          
          <!-- Gradients for vibrant colors -->
          <linearGradient id="redGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#ff1744;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#e21b2d;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#c62828;stop-opacity:1" />
          </linearGradient>
          
          <linearGradient id="whiteGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#f5f5f5;stop-opacity:1" />
          </linearGradient>
          
          <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#ffb300;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#ff8f00;stop-opacity:1" />
          </linearGradient>
          
          <!-- Japfa Orange Gradient -->
          <linearGradient id="japfaOrange" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#ff6b35;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#e85d28;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#d14d1f;stop-opacity:1" />
          </linearGradient>
          
          <!-- Shadow filters -->
          <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="black" flood-opacity="0.4"/>
          </filter>
        </defs>
        
        <!-- Background with Indonesian flag colors -->
        <g mask="url(#center-hole)">
          <!-- Red background (top half) -->
          <rect x="0" y="0" width="100%" height="390" fill="url(#redGradient)" />
          <!-- White background (bottom half) -->
          <rect x="0" y="390" width="100%" height="390" fill="url(#whiteGradient)" />
        </g>
        
        <!-- Circular frame design inspired by Japfa annual report -->
        <g mask="url(#center-hole)">
          <!-- Outer orange circle -->
          <circle cx="180" cy="390" r="180" fill="url(#japfaOrange)" />
          <circle cx="180" cy="390" r="165" fill="url(#whiteGradient)" />
          
          <!-- Inner decorative circle with dots -->
          <circle cx="180" cy="390" r="155" fill="url(#japfaOrange)" />
          <circle cx="180" cy="390" r="140" fill="url(#whiteGradient)" />
          
          <!-- White dots around the circle (like in Japfa design) -->
          <g fill="white">
            <circle cx="180" cy="235" r="8" />
            <circle cx="225" cy="250" r="8" />
            <circle cx="260" cy="280" r="8" />
            <circle cx="285" cy="320" r="8" />
            <circle cx="300" cy="365" r="8" />
            <circle cx="305" cy="415" r="8" />
            <circle cx="285" cy="460" r="8" />
            <circle cx="260" cy="500" r="8" />
            <circle cx="225" cy="530" r="8" />
            <circle cx="180" cy="545" r="8" />
            <circle cx="135" cy="530" r="8" />
            <circle cx="100" cy="500" r="8" />
            <circle cx="75" cy="460" r="8" />
            <circle cx="55" cy="415" r="8" />
            <circle cx="60" cy="365" r="8" />
            <circle cx="75" cy="320" r="8" />
            <circle cx="100" cy="280" r="8" />
            <circle cx="135" cy="250" r="8" />
          </g>
        </g>
        
        
        <!-- Header text above the circular frame -->
        <g mask="url(#center-hole)">
          <text x="180" y="80" text-anchor="middle" alignment-baseline="middle" 
                font-size="22" font-weight="800" fill="url(#whiteGradient)" 
                filter="url(#shadow)">
            80 TAHUN KEMERDEKAAN RI
          </text>
          <text x="180" y="105" text-anchor="middle" alignment-baseline="middle" 
                font-size="14" font-weight="600" fill="url(#goldGradient)" 
                filter="url(#shadow)">
            17 Agustus 1945 - 2025
          </text>
        </g>
        
        <!-- Footer text below the circular frame -->
        <g mask="url(#center-hole)">
          <text x="180" y="620" text-anchor="middle" alignment-baseline="middle" 
                font-size="18" font-weight="700" fill="url(#japfaOrange)" 
                filter="url(#shadow)">
            PT JAPFA COMFEED INDONESIA
          </text>
          <text x="180" y="645" text-anchor="middle" alignment-baseline="middle" 
                font-size="12" font-weight="600" fill="url(#redGradient)">
            Pertumbuhan yang Kuat dan Berkelanjutan
          </text>
          <text x="180" y="665" text-anchor="middle" alignment-baseline="middle" 
                font-size="10" font-weight="500" fill="url(#goldGradient)" opacity="0.8">
            Sustainable and Strong Growth
          </text>
        </g>
      </svg><rect x="70" y="570" width="220" height="1" fill="url(#goldGradient)"/>
            <rect x="90" y="590" width="180" height="1" fill="url(#japfaOrange)"/>
          </g>
        </g>
      </svg>
    </div>
    <div class="center-cta" id="startPanel"><div class="warning" id="contextWarning" style="display:none">Note, camera access requires https, or localhost. If you open this as a file, the camera may be blocked.</div><button class="cta-btn" id="startBtn">ðŸ“¹ Mulai Kamera</button><label class="cta-secondary" for="fileInput">atau unggah foto</label><input id="fileInput" type="file" accept="image/*" capture="environment" /></div>
    <div class="topbar"><div class="chip" id="flipLabel">kamera belum aktif</div></div>
    <div class="message" id="msgBox" style="display:none"></div>
    <div class="caption">Pusat foto tetap transparan, foto bisa diambil atau dibagikan</div>
    <div class="ui"><button id="switchBtn" class="secondary" title="Ganti kamera">ðŸ”„ Ganti Kamera</button><button id="captureBtn">ðŸ“· Ambil Foto</button><button id="shareBtn" class="secondary">ðŸ“¤ Bagikan</button></div>
    <a class="sr-only" id="downloadLink">download</a>
  </div>

  <script>
    const video = document.getElementById('camera');
    const captureBtn = document.getElementById('captureBtn');
    const shareBtn = document.getElementById('shareBtn');
    const switchBtn = document.getElementById('switchBtn');
    const flipLabel = document.getElementById('flipLabel');
    const startBtn = document.getElementById('startBtn');
    const fileInput = document.getElementById('fileInput');
    const startPanel = document.getElementById('startPanel');
    const msgBox = document.getElementById('msgBox');
    const contextWarning = document.getElementById('contextWarning');

    let stream = null;
    let usingFront = true;
    let usingFileFallback = false;

    function showMessage(text, level = 'info') {
      msgBox.style.display = 'block';
      msgBox.textContent = text;
      msgBox.style.background = level === 'error' ? 'rgba(255,205,210,0.95)' : 'rgba(0,0,0,0.55)';
    }

    function clearMessage() { msgBox.style.display = 'none'; msgBox.textContent = ''; }
    function isSecureContext() { return location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1'; }
    if (!isSecureContext()) { contextWarning.style.display = 'block'; }

    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }

    function showImagePreview(blob) {
      const oldOverlay = document.getElementById('previewOverlay');
      if (oldOverlay) oldOverlay.remove();
      
      const overlay = document.createElement('div');
      overlay.id = 'previewOverlay';
      
      const img = document.createElement('img');
      const blobUrl = URL.createObjectURL(blob);
      img.src = blobUrl;
      
      const instruction = document.createElement('p');
      instruction.className = 'instruction';
      instruction.textContent = 'Tekan lama pada gambar untuk menyimpan, lalu tutup.';

      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Tutup';
      closeBtn.className = 'close-btn';

      overlay.appendChild(img);
      overlay.appendChild(instruction);
      overlay.appendChild(closeBtn);
      document.body.appendChild(overlay);

      closeBtn.onclick = () => {
        overlay.remove();
        URL.revokeObjectURL(blobUrl);
      };
    }
    
    function handleDownload(blob, filename) {
      if (isIOS()) {
        showImagePreview(blob);
      } else {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => URL.revokeObjectURL(link.href), 100);
      }
    }
    
    async function startCamera() {
      clearMessage();
      usingFileFallback = false;
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      const constraints = { video: { facingMode: usingFront ? 'user' : 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: false };
      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      } catch (err) {
        if (err.name === 'NotAllowedError') { showMessage('Izin kamera ditolak. Izinkan di pengaturan browser atau unggah foto.', 'error'); return; }
        try { stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false }); } 
        catch (err2) { showMessage('Tidak dapat mengakses kamera. Gunakan tombol unggah foto.', 'error'); return; }
      }
      video.srcObject = stream;
      video.onloadedmetadata = () => video.play();
      video.style.transform = usingFront ? 'scaleX(-1)' : 'scaleX(1)';
      flipLabel.textContent = usingFront ? 'kamera depan' : 'kamera belakang';
      startPanel.style.display = 'none';
      clearMessage();
    }

    switchBtn.addEventListener('click', async () => {
      if (usingFileFallback) { showMessage('Tidak bisa ganti kamera saat memakai foto.', 'info'); return; }
      usingFront = !usingFront;
      video.style.transform = usingFront ? 'scaleX(-1)' : 'scaleX(1)';
      flipLabel.textContent = 'memulai ulang kamera...';
      await startCamera();
    });

    function svgToImage(svgEl) {
      const xml = new XMLSerializer().serializeToString(svgEl);
      const blob = new Blob([xml], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = url;
      return new Promise((res, rej) => {
        img.onload = () => { URL.revokeObjectURL(url); res(img); };
        img.onerror = (e) => { URL.revokeObjectURL(url); rej(e); };
      });
    }

    async function processImage() {
      if (!stream && !usingFileFallback) { showMessage('Kamera belum aktif. Tekan "mulai kamera" atau unggah foto.', 'info'); return null; }
      const canvas = document.createElement('canvas');
      canvas.width = 1080; canvas.height = 1920;
      const ctx = canvas.getContext('2d');
      const canvasAspectRatio = canvas.width / canvas.height;
      const vw = video.videoWidth || video.clientWidth;
      const vh = video.videoHeight || video.clientHeight;
      if (vw === 0 || vh === 0) { showMessage('Gagal mendapatkan dimensi video.', 'error'); return null; }
      const videoAspectRatio = vw / vh;
      let videoSx, videoSy, videoSWidth, videoSHeight;
      if (videoAspectRatio > canvasAspectRatio) {
        videoSHeight = vh; videoSWidth = vh * canvasAspectRatio;
        videoSx = (vw - videoSWidth) / 2; videoSy = 0;
      } else {
        videoSWidth = vw; videoSHeight = vw / canvasAspectRatio;
        videoSx = 0; videoSy = (vh - videoSHeight) / 2;
      }
      if (!usingFileFallback && usingFront) {
        ctx.save(); ctx.scale(-1, 1);
        ctx.drawImage(video, videoSx, videoSy, videoSWidth, videoSHeight, -canvas.width, 0, canvas.width, canvas.height);
        ctx.restore();
      } else {
        ctx.drawImage(video, videoSx, videoSy, videoSWidth, videoSHeight, 0, 0, canvas.width, canvas.height);
      }
      try { const img = await svgToImage(document.querySelector('svg.overlay')); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); } 
      catch (e) { console.warn('Gagal menggambar overlay SVG.', e); }
      return canvas;
    }

    captureBtn.addEventListener('click', async () => {
      const canvas = await processImage();
      if (!canvas) return;
      canvas.toBlob((blob) => {
        if (!blob) { showMessage('Gagal membuat file gambar.', 'error'); return; }
        handleDownload(blob, 'indonesia80_portrait.png');
      }, 'image/png');
    });

    shareBtn.addEventListener('click', async () => {
      const canvas = await processImage();
      if (!canvas) return;
      canvas.toBlob(async (blob) => {
        if (!blob) { showMessage('Gagal membuat file untuk dibagikan.', 'error'); return; }
        const file = new File([blob], 'indonesia80_portrait.png', { type: 'image/png' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try { await navigator.share({ files: [file], title: 'Dirgahayu ke-80 RI' }); return; } 
          catch (e) { console.warn('Share API failed, falling back.', e); }
        }
        showMessage('Gagal membagikan. Silakan simpan gambar & bagikan manual.', 'info');
        handleDownload(blob, 'indonesia80_portrait.png');
      }, 'image/png');
    });

    startBtn.addEventListener('click', async () => {
      const perm = await navigator.permissions?.query({ name: 'camera' });
      if (perm?.state === 'denied') { showMessage('Izin kamera ditolak. Izinkan di pengaturan browser atau unggah foto.', 'error'); return; }
      await startCamera();
    });

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      usingFileFallback = true;
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      video.srcObject = null; video.src = url;
      video.onloadedmetadata = () => video.play();
      video.style.transform = 'scaleX(1)';
      flipLabel.textContent = 'menggunakan foto unggahan';
      startPanel.style.display = 'none';
      clearMessage();
    });

    flipLabel.textContent = 'kamera belum aktif';
    clearMessage();
  </script>
</body>
</html>